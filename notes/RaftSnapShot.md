# Raft日志压缩 

Raft在工作的过程中，日志会不断增多，导致占用的空间越来越大，查找也越来越麻烦，因此，需要定时对日志进行压缩。

Raft日志压缩的方式是快照，快照就是关于指定数据集合的一个完全可用拷贝，该拷贝包括相应数据在某个时间点（拷贝开始的时间点）的映像。 

在Raft中，每个server都可以创建快照，但是只能对已经提交的日志创建快照。快照的形式：

1. 状态机的状态（已经被提交的）

2. 被快照取代的最后的条目在日志中的索引值（状态机最后应用的日志）

3. 最后被包含的任期指的是该条目的任期号


![](https://upload-images.jianshu.io/upload_images/4440914-3bcf8c61f0e80576.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

为了一致性检查，需要在快照中保存最后被包含的索引和最后被包含的任期的值。 

完成一次快照之后，server删除索引位置之前的日志和快照。这就完成了一次日志压缩。 

一般都是服务器独自创建快照进行日志压缩，但有时需要leader发送快照给follower，这种情况一般发生在follower的日志落后太多或一个新的follower加入集群的情况下，通过领导人发送快照的方式，使follower的状态在较短时间内与leader一致。 

同样的，leader发送快照给follower是通过RPC的方式，具体如下：

![](https://upload-images.jianshu.io/upload_images/4440914-db40e02171503070.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
 
为了便于传输，快照都是被分成分块的，同时，快照RPC也可以使接收者重置选举超时计时器，类似与心跳RPC。

|参数|说明|
|--|--|
|term|leader的任期值|
|leaderId|leader的ID|
|lastIncludedIndex|快照中包含的最后一条日志的索引值|
|lastIncludedTerm|快照中包含的最后一条日志的任期值|
|offset|此分块在快照中的偏移值|
|data[]|数据|
|done|如果次分块是最后一个分块为true| 

接收者：

1. 如果 term < currentTerm，立刻返回（回复）

2. 如果 offset为0（第一个分块），创建一个快照文件

3. 把这个分块的数据写入快照文件中

4. 如果 done不是true，回复并等待更多的分块

5. 保存日志文件，丢弃索引值更小的现有或部分的快照。

6. 如果现存的日志条目拥有相同的最后任期号和索引值，则保留此日志后面的日志

7. 丢弃日志

8. 用快照重置状态机的状态

对于接收者来说，要如何处置来自leader的快照是与自身的日志有关的。

如果快照中包含接收者的日没有的信息，那么接收者会丢弃自己的全部日志，用快照替代；如果接受的快照是接收者日志的前面部分，那么接收者删除被快照包含的条目，同时保留快照之后的条目。 





